---
title: 'Distributed Tracing v·ªõi Zipkin + Kafka + Docker + Spring Boot: Tracing - H√†nh tr√¨nh tr·ªü th√†nh Sherlock Dev'
abstract: 'Distributed Tracing v·ªõi Zipkin + Kafka + Docker + Spring Boot: Tracing - H√†nh tr√¨nh tr·ªü th√†nh Sherlock Dev.'
date: '2023-12-03'
banner: https://i.ibb.co/8K1qjhj/zipkin-tracing.png
featured: false
keywords:
  [
    'spring boot',
    'zipkin',
    'tracing',
    'kafka',
    'mariadb',
    'docker',
    'brave',
  ]
updated: '2023-12-03T08:00:00.000Z'
---
H√†nh tr√¨nh tr·ªü th√†nh m·ªôt **th√°m t·ª≠ chuy√™n nghi·ªáp** c·ªßa m·ªôt developer.

> M·ªùi b·∫°n tham kh·∫£o b√†i vi·∫øt tr∆∞·ªõc v·ªÅ l√Ω thuy·∫øt tracing: [**Distributed Tracing Concepts**](https://dieptv.vercel.app/articles/tracing-concepts/)


> L∆∞u √Ω: M√¨nh d√πng **Spring Boot 3** nh√© ^.^
> N·∫øu c√°c b·∫°n d√πng **Spring Boot 2** c√≥ th·ªÉ tham kh·∫£o th∆∞ vi·ªán [Spring Cloud Sleuth](https://spring.io/projects/spring-cloud-sleuth)

Ok, v·∫≠y l√† b·∫°n c√≥ m·ªôt ·ª©ng d·ª•ng microservice th·∫≠t l·ªõn, trong ƒë√≥ b·∫°n c√≥ nhi·ªÅu service c·ªông t√°c v·ªõi nhau ƒë·ªÉ ƒë·∫°t ƒë∆∞·ª£c m·ªôt ƒëi·ªÅu g√¨ ƒë√≥. N√≥ th·∫≠t tuy·ªát v·ªùi!
> Microservices s·∫Ω gi·ªëng nh∆∞: "Con b√© ƒë√≥ d·ªÖ th∆∞∆°ng ‚ù§Ô∏è".

Tuy nhi√™n, vi·ªác g·ª° l·ªói v√† kh·∫Øc ph·ª•c s·ª± c·ªë tr·ªü n√™n ng√†y c√†ng kh√≥ khƒÉn khi quy m√¥ c·ªßa ·ª©ng d·ª•ng ng√†y c√†ng l·ªõn:
- multiple services: nhi·ªÅu service v√† m·ªói service l√†m m·ªôt c√¥ng vi·ªác ƒë·ªôc l·∫≠p v·ªõi nhau
- multiple instance per service: m·ªôt service c√≥ nhi·ªÅu phi√™n b·∫£n, c√°c d·ªãch v·ª• th√¨ ƒë·ªÅu kh√¥ng c√≥ tr·∫°ng th√°i v√† c√≥ th·ªÉ m·ªü r·ªông theo chi·ªÅu ngang.
- v√† ƒë√¥i khi b·∫°n c√≤n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p v√†o m√°y ch·ªß, node ƒë·ªÉ l·∫•y log xem ·ª©ng d·ª•ng c·ªßa ch√∫ng ta g·∫∑p l·ªói g√¨, l·ªói ·ªü ƒë√¢u.

> "Con b√© ƒë√≥ d·ªÖ th∆∞∆°ng ‚ù§Ô∏è" -> "**M·∫Øt n√≥ ƒë·∫πp nh∆∞ng bi·∫øc. N·ªôi s·ª£ sau n√†y n√≥ s·∫Ω kh·ªï üíò**".

Kh√¥ng c√≥ g√¨ sai v·ªõi nh·ªØng h·∫°n ch·∫ø tr√™n - tr√™n th·ª±c t·∫ø, nh·ªØng v·∫•n ƒë·ªÅ tr√™n l√† kh√¥ng th·ªÉ tr√°nh kh·ªèi, ƒë·∫∑c bi·ªát l√† khi ch√∫ng ch·∫°y trong m√¥i tr∆∞·ªùng PaaS (Platform as a service).

V·∫≠y l√†m sao ƒë·ªÉ khi·∫øn m·ªçi th·ª© tr·ªü n√™n d·ªÖ d√†ng v√† d·ªÖ qu·∫£n l√Ω h∆°n khi n√≥i ƒë·∫øn kh·∫£ nƒÉng hi·ªÉn th·ªã t·∫•t c·∫£ nh·ªØng th√¥ng tin chuy√™n s√¢u ·ªü t·∫ßng ·ª©ng d·ª•ng?

Kh√¥ng c√≥ vi√™n ƒë·∫°n b·∫°c ("silver bullet") n√†o nh∆∞ v·∫≠y? Nh∆∞ng ch√∫ng ta c√≥ nh·ªØng c√¥ng c·ª• c√≥ th·ªÉ gi√∫p ch√∫ng ta qu·∫£n l√Ω m·ªôt ph·∫ßn n√†o ƒë√≥.

> Blog n√†y tr√¨nh b√†y v·ªÅ c√°c ·ª©ng d·ª•ng Spring Boot t·∫≠n d·ª•ng th∆∞ vi·ªán [Micrometer Tracing](https://micrometer.io/docs/tracing) ƒë·ªÉ theo d√µi c√°c y√™u c·∫ßu/ giao d·ªãch (transaction) ·ªü c·∫•p ·ª©ng d·ª•ng v√† g·ª≠i th√¥ng tin theo d√µi
ƒë·∫øn m√°y ch·ªß Zipkin t·ª´ xa th√¥ng qua Kafka.

> T·∫•t c·∫£ ƒë∆∞·ª£c tri·ªÉn khai tr√™n Docker

> M·∫∑c d√π m√£ ngu·ªìn ƒë∆∞·ª£c tri·ªÉn khai tr√™n Java, tuy nhi√™n nh·ªØng kh√°i ni·ªám ·ªü ƒë√¢y ƒë·ªÅu c√≥ th·ªÉ √°p d·ª•ng ƒë·ªëi v·ªõi b·∫•t k·ª≥ h·ªá th·ªëng n√†o c√≥ th·ªÉ t·∫°o ra d·ªØ li·ªáu theo d√µi c√πng ƒë·ªãnh d·∫°ng OpenZipkin.

> ƒê·ªçc th√™m v·ªÅ Zipkin t·∫°i: https://github.com/openzipkin/zipkin

## Ki·∫øn tr√∫c s·ª≠ d·ª•ng trong b√†i vi·∫øt
<SpaceMdx />
<img src={'/static/zipkin-kafka-docker.png'} alt={'zipkin-kafka-docker'} width={'100%'}/>
<SpaceMdx />

R·∫•t d·ªÖ hi·ªÉu ƒë·ªëi v·ªõi ki·∫øn tr√∫c tr√™n, nh·ªù c√≥ micrometer-tracing, c√°c service Spring Boot ri√™ng l·∫ª s·∫Ω g·ª≠i d·ªØ li·ªáu span/ trace t·ªõi Kafka.
Sau ƒë√≥ Zipkin s·∫Ω s·ª≠ d·ª•ng lib collector-kafka ƒë·ªÉ nh·∫≠n message t·ª´ kafka m·ªói 1s sau ƒë√≥ t·ªïng h·ª£p v√† l∆∞u v√†o mysql.
D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c tr·ª±c quan h√≥a tr√™n Zipkin Dashboard.

## Build & Deployment
C√°c th√†nh ph·∫ßn Docker ƒë∆∞·ª£c t·∫°o theo file docker-compose sau:
*kafka-compose.yml*
```dockerfile
version: '2'
services:
  zookeeper-1:
    image: confluentinc/cp-zookeeper:latest
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - 22181:2181

  kafka-1:
    container_name: kafka1
    image: confluentinc/cp-kafka:latest
    depends_on:
      - zookeeper-1

    ports:
      - 29092:29092
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-1:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: EXTERNAL:PLAINTEXT,INTERNAL:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: EXTERNAL://localhost:29092,INTERNAL://kafka1:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
  kafka-2:
    container_name: kafka2
    image: confluentinc/cp-kafka:latest
    depends_on:
      - zookeeper-1
    ports:
      - 29093:29093
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-1:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: EXTERNAL:PLAINTEXT,INTERNAL:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: EXTERNAL://localhost:29093,INTERNAL://kafka2:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
  kafdrop:
    image: obsidiandynamics/kafdrop
    restart: "no"
    environment:
      KAFKA_BROKERCONNECT: "kafka2:9092,kafka1:9092"
    ports:
      - "9002:9000"
    depends_on:
      - kafka-1
      - kafka-2
  zipkin:
    image: openzipkin/zipkin
    container_name: zipkin
    environment:
      - STORAGE_TYPE=mysql
      # Point the zipkin at the storage backend
      - MYSQL_HOST=host.docker.internal
      - MYSQL_USER=review
      - MYSQL_PASS=Techlens@321
      - MYSQL_DB=zipkin
      - MYSQL_TCP_PORT=3306
      - MYSQL_MAX_CONNECTIONS=10
      # Uncomment to enable scribe
      # - SCRIBE_ENABLED=true
      # Uncomment to enable self-tracing
      # - SELF_TRACING_ENABLED=true
      # Uncomment to enable debug logging
      - JAVA_OPTS=-Dlogging.level.zipkin2=DEBUG -Dlogging.level.org.apache.kafka=DEBUG
      - KAFKA_BOOTSTRAP_SERVERS=kafka-1:9092
      - KAFKA_TOPIC=zipkin
    ports:
      # Port used for the Zipkin UI and HTTP Api
      - 9411:9411
    depends_on:
      - kafka-1
      - kafka-2
```

B·∫°n c√≥ th·ªÉ ch·∫°y docker-compose theo l·ªánh
```shell
docker-compose -f .\kafka-compose.yml  up -d
```

```shell
docker-compose -f .\kafka-compose.yml ps
```

T·∫°o topic cho server zipkin
```shell
docker-compose -f .\kafka-compose.yml exec kafka-1 kafka-topics.sh --create --topic zipkin --consumer-property group.id=zipkin --partitions 2 --replication-factor 2 --bootstrap-server kafka-1:9092
```

Sau khi t·∫°o xong ta s·∫Ω ƒë∆∞·ª£c k·∫øt qu·∫£ nh∆∞ sau:
<SpaceMdx />
<img src={'/static/docker-zipkin-rlt.png'} alt={'docker-zipkin-rlt'} width={'100%'}/>
<SpaceMdx />

D∆∞·ªõi ƒë√¢y l√† b·∫£n t√≥m t·∫Øt c√°c th√†nh ph·∫ßn trong h·ªá th·ªëng

#### Zipkin
Zipkin  l√† m·ªôt d·ª± √°n b·∫Øt ngu·ªìn t·ª´ Twitter nƒÉm 2010 d·ª±a tr√™n c√°c b√†i b√°o v·ªÅ tracing c·ªßa Google Dapper.
- MYSQL_HOST=host.docker.internal: v·ªõi `host.docker.internal` ch√∫ng ta s·∫Ω truy c·∫≠p ƒë∆∞·ª£c localhost c·ªßa Linux/ Window ƒë·ªÉ k·∫øt n·ªëi ƒë·∫øn Mariadb
- C√°c th√¥ng s·ªë MYSQL kh√°c ƒë∆∞·ª£c c·∫•u h√¨nh kh√° d·ªÖ hi·ªÉu n√™n m√¨nh kh√¥ng gi·∫£i th√≠ch l·∫°i
- Tr∆∞·ªõc khi ch·∫°y zipkin c√°c b·∫°n ph·∫£i t·∫°o b·∫£ng trong database MariaDB theo script sau [MysSQL + Zipkin](https://github.com/openzipkin/zipkin/blob/master/zipkin-storage/mysql-v1/src/main/resources/mysql.sql)

#### Kafka
·ªû phi√™n b·∫£n docker-compose n√†y m√¨nh ch·∫°y 2 node kafka + 1 zookeeper ƒë·ªÉ gi·∫£ ƒë·ªãnh vi·ªác k·∫øt n·ªëi nhi·ªÅu node cho h·ªá th·ªëng microservice v√† zipkin.

#### Kafdrop
ƒê∆∞·ª£c d√πng ƒë·ªÉ qu·∫£n l√Ω kafka v√† theo d√µi tr·ª±c quan c√°c b·∫£n ghi ƒë∆∞·ª£c g·ª≠i t·ª´ c√°c service Spring Boot.

## D·ª±ng m·ªôt service phi√™n b·∫£n code thi·∫øu nhi v·ªõi micrometer-tracing

### 1. Setup
M√¨nh ƒë√£ t·∫°o m·ªôt service demo theo h∆∞·ªõng d·∫´n trong intellij v√† th√™m c√°c th√†nh ph·∫ßn ph·ª• thu·ªôc b√™n d∆∞·ªõi v√†o *pom.xml*:
```yml
<!-- https://mvnrepository.com/artifact/io.micrometer/micrometer-tracing -->
<dependency>
  <groupId>io.micrometer</groupId>
  <artifactId>micrometer-tracing</artifactId>
  <version>1.2.0</version>
</dependency>
<!-- https://mvnrepository.com/artifact/org.springframework.kafka/spring-kafka -->
<dependency>
  <groupId>org.springframework.kafka</groupId>
  <artifactId>spring-kafka</artifactId>
  <version>3.1.0</version>
  </dependency>
<!-- https://mvnrepository.com/artifact/io.zipkin.reporter2/zipkin-sender-kafka -->
<dependency>
  <groupId>io.zipkin.reporter2</groupId>
  <artifactId>zipkin-sender-kafka</artifactId>
  <version>2.16.4</version>
</dependency>
```

### 2. Configuration
ƒê·∫ßu ti√™n, h√£y th√™m c√°c c·∫•u h√¨nh n√†y v√†o trong file *application.yml*:

C·∫•u h√¨nh kafka:
```yml
spring:
  ...

  kafka:
    bootstrap-servers: localhost:29092
    consumer:
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      group-id: zipkin
    producer:
      acks: 0 # g·ª≠i kh√¥ng an to√†n, g·ª≠i kh√¥ng nh·∫≠n ack
      batch-size: 4
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer

  zipkin:
    kafka:
      topic: zipkin
      group-id: zipkin
```
> Thay th·∫ø c√°c th√¥ng s·ªë kafka cho ph√π h·ª£p v·ªõi ·ª©ng d·ª•ng c·ªßa b·∫°n

C·∫•u h√¨nh log format zipkin:
```yml
logging:
  pattern:
    level: '%5p [${spring.application.name:},%X{traceId:-},%X{spanId:-}]'
```
·ªû ƒë√¢y c√≥ traceId v√† spanId t∆∞∆°ng ·ª©ng v·ªõi m·ªói ƒë∆°n v·ªã c√¥ng vi·ªác c∆° b·∫£n. B·∫°n c√≥ th·ªÉ xem l·∫°i ƒë·ªãnh nghƒ©a t·∫°i v√†i vi·∫øt n√†y:
[Distributed Tracing Concepts](https://dieptv.vercel.app/articles/tracing-concepts/)

C·∫•u h√¨nh t·ªâ l·ªá l·∫•y m·∫´u tracing (m·∫∑c ƒë·ªãnh l√† 0.1-10% request ƒë·ªïi th√†nh 1.0-100% request)
```yml
management:
  tracing:
    sampling:
      probability: 1.0
```

Ti·∫øp theo m√¨nh t·∫°o m·ªôt sender zipkin d√πng ƒë·ªÉ g·ª≠i th√¥ng tin ƒë·∫øn kafka m·ªói khi c√≥ m·ªôt request y√™u c·∫ßu ƒë·∫øn server:
```java
@Configuration
@EnableConfigurationProperties(KafkaProperties.class)
public class KafkaConfig {

    static String join(List<?> parts) {
        StringBuilder to = new StringBuilder();
        for (int i = 0, length = parts.size(); i < length; i++) {
            to.append(parts.get(i));
            if (i + 1 < length) {
                to.append(',');
            }
        }
        return to.toString();
    }

    @Bean("zipkinSender")
    Sender kafkaSender(KafkaProperties config, Environment environment) {
        // Need to get property value from Environment
        // because when using @VaultPropertySource in reactive web app
        // this bean is initiated before @Value is resolved
        // See gh-1990
        String topic = environment.getProperty("spring.zipkin.kafka.topic", "zipkin");
        String groupId = environment.getProperty("spring.zipkin.kafka.group-id", "zipkin");
        Map<String, Object> properties = new HashMap<>();
        properties.put("key.serializer", ByteArraySerializer.class);
        properties.put("value.serializer", ByteArraySerializer.class);
        properties.put(ConsumerConfig.GROUP_ID_CONFIG, groupId);
        // Kafka expects the input to be a String, but KafkaProperties returns a list
        List<String> bootstrapServers = config.getBootstrapServers();
            properties.put("bootstrap.servers", join(bootstrapServers));
        return KafkaSender.newBuilder().topic(topic).overrides(properties).build();
    }
}
```

Bean m·∫∑c ƒë·ªãnh c·ªßa zipkin l√† *zipkinSender*, m√¨nh s·∫Ω ghi ƒë√® n√≥. *KafkaSender* l√† class trong th∆∞ vi·ªán zipkin-sender-kafka
Code tr√™n th√¨ ƒë∆°n gi·∫£n r·ªìi, m√¨nh s·∫Ω kh√¥ng gi·∫£i th√≠ch ·ªü ƒë√¢y.

Cu·ªëi c√πng, m√¨nh s·∫Ω t·∫°o 1 api ƒë·ªÉ ki·ªÉm tra xem micrometer-tracing c√≥ ho·∫°t ƒë·ªông hay kh√¥ng.
```java
@RestController
public class PingController {

    Logger logger = LoggerFactory.getLogger(PingController.class);
    @GetMapping("/ping")
    public String ping() {
        logger.info("pong");
        return "pong";
    }
}
```
### K·∫øt qu·∫£
Khi g·ª≠i m·ªôt request ƒë·∫øn backend service
```
curl --location 'localhost:6000/techlens/ping'
```

Ch√∫ng ta s·∫Ω c√≥ log nh∆∞ sau:
<SpaceMdx />
<img src={'/static/spring-tracing-rlt.png'} alt={'zipkin-kafka-docker'} width={'100%'}/>
<SpaceMdx />

·ªû ƒë√¢y ch√∫ng ta c√≥ log:
> ...[tracing-example,656c52a30c63df1831e9d48fe1f1b9c5,31e9d48fe1f1b9c5]...

TraceId: 656c52a30c63df1831e9d48fe1f1b9c5

SpanId: 31e9d48fe1f1b9c5

> c√°c th√¥ng tin n√†y (Span Record) ƒë∆∞·ª£c g·ª≠i v·ªÅ kafka v√† ch√∫ng ta c√≥ th·ªÉ xem tr√™n kafdrop:
<SpaceMdx />
<img src={'/static/kafka-tracing-rlt.png'} alt={'zipkin-kafka-docker'} width={'100%'}/>
<SpaceMdx />

Sau ƒë√≥ zipkin s·∫Ω thu th·∫≠p th√¥ng tin t·ª´ kafka m·ªói 1s v√† l∆∞u v√†o b·∫£ng *zipkin_spans* trong MariaDB:

<SpaceMdx />
<img src={'/static/maria-tracing-rlt.png'} alt={'zipkin-kafka-docker'} width={'100%'}/>
<img src={'/static/zipkin-rlt.png'} alt={'zipkin-kafka-docker'} width={'100%'}/>
<SpaceMdx />

[//]: # (Cu·ªëi c√πng m√¨nh t·ªïng h·ª£p l·∫°i lu·ªìng ƒëi c·ªßa m·ªôt trace b·∫±ng h√¨nh ·∫£nh sau;)

[//]: # ()

## T·ªïng k·∫øt

Nh∆∞ v·∫≠y, b√†i vi·∫øt n√†y m√¨nh ƒë√£ tr√¨nh b√†y m·ªôt c√°ch c∆° b·∫£n ƒë·ªÉ d·ª±ng m·ªôt h·ªá th·ªëng tracing s·ª≠ d·ª•ng Zipkin ƒë·ªÉ theo d√µi v√† kafka ƒë·ªÉ nh·∫≠n g·ª≠i t√≠n hi·ªáu.

Trong b√†i vi·∫øt ti·∫øp theo m√¨nh s·∫Ω l√†m m·ªôt h·ªá th·ªëng g·ªìm c·∫£ frontend v√† backend ƒë·ªÉ theo d√µi v√† tr·ª±c quan h√≥a nh·ªØng g√¨ m√† zipkin thu th·∫≠p ƒë∆∞·ª£c.
·ª®ng d·ª•ng n√†y s·∫Ω th·ªÉ hi·ªán m·ªôt c√°c tr·ª±c quan h∆°n, ƒë·∫πp h∆°n v√† th·ªÉ hi·ªán r√µ r√†ng h∆°n m·ªëi quan h·ªá gi·ªØa c√°c service, instance per service v·ªõi nhau.

> H·∫øt r·ªìi. N·∫øu anh em c√≥ g√¨ th·∫Øc m·∫Øc th√¨ g·ª≠i cho m√¨nh th√¥ng qua emal diep.tv1999@gmail.com n√†y nh√©.

Bye!
